<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrapbox API Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 p-8">
    <div class="container mx-auto max-w-4xl">
        <h1 class="text-3xl font-bold mb-8">Scrapbox API Test</h1>
        
        <!-- 設定セクション -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">API設定</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="project-name" class="block text-sm font-medium text-gray-300 mb-2">プロジェクト名:</label>
                    <input type="text" id="project-name" value="your-project" 
                           class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="connect-sid" class="block text-sm font-medium text-gray-300 mb-2">connect.sid:</label>
                    <input type="password" id="connect-sid" placeholder="Cookieから取得したconnect.sidを入力"
                           class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="text-xs text-gray-400 mb-4">
                <p><strong>connect.sid取得方法:</strong></p>
                <p>1. Scrapboxにログイン → 2. 開発者ツール(F12) → 3. Application → 4. Cookies → 5. connect.sidをコピー</p>
            </div>
        </div>

        <!-- テストボタン -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">APIテスト</h2>
            <div class="flex flex-wrap gap-4 mb-4">
                <button id="test-export-api" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    Export API テスト
                </button>
                <button id="test-with-metadata" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    メタデータ付きテスト
                </button>
                <button id="clear-log" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    ログクリア
                </button>
            </div>
        </div>

        <!-- 結果表示 -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">テスト結果</h2>
            <div id="status" class="mb-4 p-3 rounded bg-gray-700 text-gray-300">
                待機中...
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">レスポンス詳細:</label>
                <pre id="response-details" class="bg-gray-900 p-4 rounded text-xs overflow-auto max-h-96 text-green-400">
                </pre>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">エラーログ:</label>
                <pre id="error-log" class="bg-gray-900 p-4 rounded text-xs overflow-auto max-h-48 text-red-400">
                </pre>
            </div>
        </div>
    </div>

    <script>
        // DOM要素
        const projectNameInput = document.getElementById('project-name');
        const connectSidInput = document.getElementById('connect-sid');
        const testExportBtn = document.getElementById('test-export-api');
        const testMetadataBtn = document.getElementById('test-with-metadata');
        const clearLogBtn = document.getElementById('clear-log');
        const statusDiv = document.getElementById('status');
        const responseDetails = document.getElementById('response-details');
        const errorLog = document.getElementById('error-log');

        // ログ関数
        function logStatus(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            statusDiv.textContent = `[${timestamp}] ${message}`;
            statusDiv.className = `mb-4 p-3 rounded ${
                type === 'error' ? 'bg-red-900 text-red-300' :
                type === 'success' ? 'bg-green-900 text-green-300' :
                type === 'warning' ? 'bg-yellow-900 text-yellow-300' :
                'bg-gray-700 text-gray-300'
            }`;
        }

        function logResponse(data) {
            responseDetails.textContent = JSON.stringify(data, null, 2);
        }

        function logError(error) {
            const timestamp = new Date().toLocaleTimeString();
            errorLog.textContent += `[${timestamp}] ${error}\n`;
        }

        // API呼び出し関数
        async function testScrapboxAPI(includeMetadata = false) {
            const projectName = projectNameInput.value.trim();
            const connectSid = connectSidInput.value.trim();

            if (!projectName) {
                logStatus('プロジェクト名を入力してください', 'error');
                return;
            }

            if (!connectSid) {
                logStatus('connect.sidを入力してください', 'error');
                return;
            }

            try {
                logStatus('API呼び出し中...', 'info');
                
                const url = `https://scrapbox.io/api/page-data/export/${projectName}.json${includeMetadata ? '?metadata=true' : ''}`;
                
                logStatus(`URL: ${url}`, 'info');

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Cookie': `connect.sid=${connectSid}`
                    },
                    mode: 'cors', // CORS明示的に指定
                    credentials: 'include' // Cookieを含める
                });

                logStatus(`HTTP Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'warning');

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                logStatus(`データ取得成功！ページ数: ${data.pages ? data.pages.length : 'N/A'}`, 'success');
                logResponse(data);

                // 基本情報を表示
                if (data.name) {
                    logStatus(`プロジェクト: ${data.name}, 最終エクスポート: ${new Date(data.exported * 1000).toLocaleString()}`, 'success');
                }

            } catch (error) {
                logStatus(`エラー: ${error.message}`, 'error');
                logError(error.stack || error.message);
                
                // CORS エラーの場合の追加情報
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    logError('CORS制限の可能性があります。Scrapbox内で実行するか、GASプロキシを検討してください。');
                }
            }
        }

        // イベントリスナー
        testExportBtn.addEventListener('click', () => testScrapboxAPI(false));
        testMetadataBtn.addEventListener('click', () => testScrapboxAPI(true));
        
        clearLogBtn.addEventListener('click', () => {
            responseDetails.textContent = '';
            errorLog.textContent = '';
            logStatus('ログをクリアしました', 'info');
        });

        // ページ読み込み時の初期化
        logStatus('APIテストの準備完了', 'info');
    </script>
</body>
</html>